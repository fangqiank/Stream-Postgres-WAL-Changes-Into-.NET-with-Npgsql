<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PostgreSQL CDC 监控面板</title>

    <!-- Custom CSS instead of Tailwind CDN to avoid production warnings -->
    <style>
        /* Basic utility classes similar to Tailwind */
        * { box-sizing: border-box; }
        body { margin: 0; font-family: system-ui, -apple-system, sans-serif; }
        .bg-gray-50 { background-color: #f9fafb; }
        .bg-white { background-color: white; }
        .bg-gray-100 { background-color: #f3f4f6; }
        .bg-gray-200 { background-color: #e5e7eb; }
        .bg-gray-700 { background-color: #374151; }
        .bg-gray-800 { background-color: #1f2937; }
        .bg-gray-900 { background-color: #111827; }
        .bg-red-500 { background-color: #ef4444; }
        .bg-red-600 { background-color: #dc2626; }
        .bg-red-900 { background-color: #7f1d1d; }
        .bg-red-100 { background-color: #fef2f2; }
        .bg-yellow-500 { background-color: #eab308; }
        .bg-yellow-600 { background-color: #ca8a04; }
        .bg-yellow-700 { background-color: #a16207; }
        .bg-yellow-900 { background-color: #713f12; }
        .bg-yellow-100 { background-color: #fef3c7; }
        .bg-green-500 { background-color: #22c55e; }
        .bg-green-600 { background-color: #16a34a; }
        .bg-green-900 { background-color: #14532d; }
        .bg-green-100 { background-color: #dcfce7; }
        .bg-blue-500 { background-color: #3b82f6; }
        .bg-blue-600 { background-color: #2563eb; }
        .bg-blue-700 { background-color: #1d4ed8; }
        .bg-blue-900 { background-color: #1e3a8a; }
        .bg-blue-100 { background-color: #dbeafe; }
        .text-white { color: white; }
        .text-gray-900 { color: #111827; }
        .text-gray-800 { color: #1f2937; }
        .text-gray-700 { color: #374151; }
        .text-gray-600 { color: #4b5563; }
        .text-gray-500 { color: #6b7280; }
        .text-gray-400 { color: #9ca3af; }
        .text-gray-300 { color: #d1d5db; }
        .text-red-800 { color: #991b1b; }
        .text-red-700 { color: #b91c1c; }
        .text-red-600 { color: #dc2626; }
        .text-red-500 { color: #ef4444; }
        .text-red-400 { color: #f87171; }
        .text-red-300 { color: #fca5a5; }
        .text-red-200 { color: #fecaca; }
        .text-yellow-800 { color: #92400e; }
        .text-yellow-700 { color: #a16207; }
        .text-yellow-600 { color: #ca8a04; }
        .text-yellow-500 { color: #eab308; }
        .text-yellow-400 { color: #facc15; }
        .text-yellow-300 { color: #fde047; }
        .text-yellow-200 { color: #fef3c7; }
        .text-green-800 { color: #166534; }
        .text-green-700 { color: #15803d; }
        .text-green-600 { color: #16a34a; }
        .text-green-500 { color: #22c55e; }
        .text-green-400 { color: #4ade80; }
        .text-green-300 { color: #86efac; }
        .text-green-200 { color: #dcfce7; }
        .text-blue-800 { color: #1e40af; }
        .text-blue-700 { color: #1d4ed8; }
        .text-blue-600 { color: #2563eb; }
        .text-blue-500 { color: #3b82f6; }
        .text-blue-400 { color: #60a5fa; }
        .text-blue-300 { color: #93c5fd; }
        .text-blue-200 { color: #dbeafe; }
        .p-1 { padding: 0.25rem; }
        .p-2 { padding: 0.5rem; }
        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .p-8 { padding: 2rem; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
        .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
        .m-4 { margin: 1rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .ml-4 { margin-left: 1rem; }
        .mr-2 { margin-right: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-8 { margin-top: 2rem; }
        .w-3 { width: 0.75rem; }
        .w-8 { width: 2rem; }
        .w-full { width: 100%; }
        .h-3 { height: 0.75rem; }
        .h-8 { height: 2rem; }
        .h-screen { height: 100vh; }
        .min-h-screen { min-height: 100vh; }
        .max-w-7xl { max-width: 80rem; margin-left: auto; margin-right: auto; }
        .max-w-md { max-width: 28rem; margin-left: auto; margin-right: auto; }
        .flex { display: flex; }
        .inline-flex { display: inline-flex; }
        .grid { display: grid; }
        .hidden { display: none; }
        .fixed { position: fixed; }
        .absolute { position: absolute; }
        .relative { position: relative; }
        .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
        .z-40 { z-index: 40; }
        .z-50 { z-index: 50; }
        .items-center { align-items: center; }
        .items-start { align-items: flex-start; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .space-x-2 > * + * { margin-left: 0.5rem; }
        .space-x-4 > * + * { margin-left: 1rem; }
        .space-y-2 > * + * { margin-top: 0.5rem; }
        .space-y-3 > * + * { margin-top: 0.75rem; }
        .space-y-4 > * + * { margin-top: 1rem; }
        .rounded { border-radius: 0.25rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-md { border-radius: 0.375rem; }
        .rounded-full { border-radius: 9999px; }
        .border { border-width: 1px; border-style: solid; border-color: #e5e7eb; }
        .border-gray-200 { border-color: #e5e7eb; }
        .border-gray-300 { border-color: #d1d5db; }
        .border-gray-600 { border-color: #4b5563; }
        .border-gray-700 { border-color: #374151; }
        .border-t { border-top: 1px solid #e5e7eb; }
        .border-b { border-bottom: 1px solid #e5e7eb; }
        .shadow { box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .text-xs { font-size: 0.75rem; line-height: 1rem; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
        .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
        .text-2xl { font-size: 1.5rem; line-height: 2rem; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        .text-center { text-align: center; }
        .hover\:bg-gray-200:hover { background-color: #e5e7eb; }
        .hover\:bg-gray-600:hover { background-color: #4b5563; }
        .hover\:bg-gray-700:hover { background-color: #374151; }
        .hover\:bg-red-700:hover { background-color: #b91c1c; }
        .hover\:bg-yellow-700:hover { background-color: #a16207; }
        .hover\:bg-yellow-600:hover { background-color: #ca8a04; }
        .hover\:bg-blue-700:hover { background-color: #1d4ed8; }
        .hover\:bg-blue-600:hover { background-color: #2563eb; }
        .hover\:shadow-md:hover { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .focus\:outline-none:focus { outline: none; }
        .focus\:ring-2:focus { box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); }
        .focus\:ring-blue-500:focus { box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); }
        .focus\:ring-yellow-500:focus { box-shadow: 0 0 0 2px rgba(234, 179, 8, 0.5); }
        .focus\:ring-offset-2:focus { box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5), 0 0 0 calc(4px) rgba(59, 130, 246, 0.5); }
        .transition-colors { transition-property: color, background-color, border-color; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .col-span-1 { grid-column: span 1 / span 1; }
        .col-span-2 { grid-column: span 2 / span 2; }
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
        .lg\:grid-cols-2 { @media (min-width: 1024px) { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
        .md\:grid-cols-4 { @media (min-width: 768px) { grid-template-columns: repeat(4, minmax(0, 1fr)); } }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .pulse-green { animation: pulseGreen 2s infinite; }
        @keyframes pulseGreen {
            0%, 100% { box-shadow: 0 0 5px rgba(34, 197, 94, 0.5); }
            50% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.8); }
        }
        .error-boundary { border: 1px solid #fecaca; background: #fef2f2; }
        .dark { color-scheme: dark; }
        .dark .bg-gray-50 { background-color: #111827; }
        .dark .bg-white { background-color: #1f2937; }
        .dark .bg-gray-100 { background-color: #374151; }
        .dark .bg-gray-200 { background-color: #4b5563; }
        .dark .bg-gray-700 { background-color: #374151; }
        .dark .bg-gray-800 { background-color: #1f2937; }
        .dark .bg-gray-900 { background-color: #111827; }
        .dark .text-gray-900 { color: #f9fafb; }
        .dark .text-gray-800 { color: #f3f4f6; }
        .dark .text-gray-700 { color: #e5e7eb; }
        .dark .text-gray-600 { color: #d1d5db; }
        .dark .text-gray-500 { color: #9ca3af; }
        .dark .text-gray-400 { color: #6b7280; }
        .dark .text-gray-300 { color: #4b5563; }
        .dark .border-gray-200 { border-color: #374151; }
        .dark .border-gray-300 { border-color: #4b5563; }
        .dark .border-gray-600 { border-color: #6b7280; }
        .dark .border-gray-700 { border-color: #374151; }
        .dark .border-t { border-color: #374151; }
        .dark .border-b { border-color: #374151; }
        .dark .error-boundary { border-color: #7f1d1d; background: #1f2937; }
    </style>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- 自定义样式 -->
    <style>
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .new-event {
            animation: highlightNew 2s ease-out;
            border-left: 4px solid #3b82f6 !important;
        }

        @keyframes highlightNew {
            0% {
                background-color: #dbeafe;
                border-left-color: #2563eb;
            }
            50% {
                background-color: #f0f9ff;
                border-left-color: #3b82f6;
            }
            100% {
                background-color: transparent;
                border-left-color: #d1d5db;
            }
        }

        .dark .new-event {
            animation: highlightNewDark 2s ease-out;
        }

        @keyframes highlightNewDark {
            0% {
                background-color: #1e3a8a;
                border-left-color: #1d4ed8;
            }
            50% {
                background-color: #1e40af;
                border-left-color: #3b82f6;
            }
            100% {
                background-color: transparent;
                border-left-color: #4b5563;
            }
        }

        .pulse-green {
            animation: pulseGreen 2s infinite;
        }

        @keyframes pulseGreen {
            0%, 100% {
                box-shadow: 0 0 5px rgba(34, 197, 94, 0.5);
            }

            50% {
                box-shadow: 0 0 20px rgba(34, 197, 94, 0.8);
            }
        }

        .error-boundary {
            border: 1px solid #fecaca;
            background: #fef2f2;
        }

        .dark .error-boundary {
            border-color: #7f1d1d;
            background: #1f2937;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen dark:bg-gray-900 transition-colors">
    <!-- 登录模态框 -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-8 max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">登录 CDC 监控面板</h2>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        用户名
                    </label>
                    <input type="text"
                           id="username"
                           required
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                           placeholder="admin"
                           value="admin">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        密码
                    </label>
                    <input type="password"
                           id="password"
                           required
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                           placeholder="password"
                           value="password">
                </div>
                <button type="submit"
                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                    登录
                </button>
            </form>
            <div class="mt-4 text-sm text-gray-600 dark:text-gray-400">
                <p>演示账号: admin / password</p>
            </div>
        </div>
    </div>

    <!-- 错误边界 -->
    <div id="errorBoundary" class="hidden error-boundary rounded-lg p-4 m-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <span class="text-red-500 text-xl mr-2">⚠️</span>
                <div>
                    <h3 class="font-semibold text-red-800 dark:text-red-400">应用错误</h3>
                    <p id="errorMessage" class="text-sm text-red-700 dark:text-red-300"></p>
                </div>
            </div>
            <button onclick="hideError()" class="text-red-500 hover:text-red-700">
                ✕
            </button>
        </div>
    </div>

    <!-- 主应用界面 -->
    <div id="app" class="hidden">
        <!-- 导航栏 -->
        <nav class="bg-white dark:bg-gray-800 shadow-sm border-b dark:border-gray-700">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <h1 class="text-xl font-bold text-gray-900 dark:text-white">
                            📊 PostgreSQL CDC 监控面板
                        </h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div id="connectionStatus" class="flex items-center">
                            <span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                            <span class="text-sm text-gray-600 dark:text-gray-400">断开连接</span>
                        </div>
                        <button onclick="toggleTheme()" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                            <span id="themeIcon">🌙</span>
                        </button>
                        <button onclick="logout()" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-sm">
                            退出登录
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- 统计卡片 -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-2 bg-blue-100 dark:bg-blue-900 rounded-lg">
                            <span class="text-blue-600 dark:text-blue-400 text-xl">📋</span>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">总订单数</p>
                            <h3 id="totalOrders" class="text-2xl font-bold text-gray-900 dark:text-white">0</h3>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-2 bg-green-100 dark:bg-green-900 rounded-lg">
                            <span class="text-green-600 dark:text-green-400 text-xl">⚡</span>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">今日事件</p>
                            <h3 id="todayEvents" class="text-2xl font-bold text-gray-900 dark:text-white">0</h3>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-2 bg-purple-100 dark:bg-purple-900 rounded-lg">
                            <span class="text-purple-600 dark:text-purple-400 text-xl">🔄</span>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">待处理事件</p>
                            <h3 id="pendingEvents" class="text-2xl font-bold text-gray-900 dark:text-white">0</h3>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-2 bg-yellow-100 dark:bg-yellow-900 rounded-lg">
                            <span class="text-yellow-600 dark:text-yellow-400 text-xl">⏱️</span>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">响应时间</p>
                            <h3 id="responseTime" class="text-2xl font-bold text-gray-900 dark:text-white">0ms</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 图表区域 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">订单趋势</h2>
                    <div style="width: 100%; height: 300px; position: relative;">
                    <canvas id="ordersChart" style="display: block; width: 100%; height: 100%; background: transparent;"></canvas>
                </div>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">状态分布</h2>
                    <div style="width: 100%; height: 300px; position: relative;">
                    <canvas id="statusChart" style="display: block; width: 100%; height: 100%; background: transparent;"></canvas>
                </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- 左侧：订单管理和创建 -->
                <div class="space-y-6">
                    <!-- 创建订单表单 -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
                        <div class="px-6 py-4 border-b dark:border-gray-700">
                            <h2 class="text-lg font-semibold text-gray-900 dark:text-white">创建新订单</h2>
                        </div>
                        <div class="p-6">
                            <form id="createOrderForm" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        客户名称
                                    </label>
                                    <input type="text"
                                           id="customerName"
                                           required
                                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                                           placeholder="输入客户名称">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        订单金额
                                    </label>
                                    <input type="number"
                                           id="orderAmount"
                                           step="0.01"
                                           min="0"
                                           required
                                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                                           placeholder="0.00">
                                </div>
                                <button type="submit"
                                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                                    创建订单
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- 订单列表 -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
                        <div class="px-6 py-4 border-b dark:border-gray-700 flex justify-between items-center">
                            <h2 class="text-lg font-semibold text-gray-900 dark:text-white">订单列表</h2>
                            <div class="flex space-x-2">
                                <input type="text"
                                       id="searchOrders"
                                       placeholder="搜索订单..."
                                       class="text-sm border border-gray-300 dark:border-gray-600 rounded px-3 py-1 dark:bg-gray-700 dark:text-white">
                                <select id="statusFilter" class="text-sm border border-gray-300 dark:border-gray-600 rounded px-2 py-1 dark:bg-gray-700 dark:text-white">
                                    <option value="All">所有状态</option>
                                    <option value="Pending">待处理</option>
                                    <option value="Processing">处理中</option>
                                    <option value="Completed">已完成</option>
                                    <option value="Cancelled">已取消</option>
                                </select>
                                <button onclick="loadOrders()" class="text-sm bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition-colors">
                                    搜索
                                </button>
                            </div>
                        </div>
                        <div class="p-4">
                            <div id="ordersList" class="space-y-3 max-h-96 overflow-y-auto">
                                <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                                    加载中...
                                </div>
                            </div>
                            <!-- 分页控件 -->
                            <div id="pagination" class="mt-4 flex justify-between items-center">
                                <div class="text-sm text-gray-600 dark:text-gray-400">
                                    显示 <span id="pageInfo">0-0</span> 共 <span id="totalCount">0</span> 条
                                </div>
                                <div class="flex space-x-2">
                                    <button id="prevPage" onclick="changePage(-1)" class="px-3 py-1 border rounded disabled:opacity-50 dark:border-gray-600">上一页</button>
                                    <div id="pageNumbers" class="flex space-x-1"></div>
                                    <button id="nextPage" onclick="changePage(1)" class="px-3 py-1 border rounded disabled:opacity-50 dark:border-gray-600">下一页</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 右侧：CDC事件流 -->
                <div class="space-y-6">
                    <!-- CDC事件监控 -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
                        <div class="px-6 py-4 border-b dark:border-gray-700 flex justify-between items-center">
                            <h2 class="text-lg font-semibold text-gray-900 dark:text-white">CDC 事件流</h2>
                            <div class="flex items-center space-x-4">
                                <button id="clearEvents" class="text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 px-3 py-1 rounded transition-colors">
                                    清空事件
                                </button>
                                <div class="flex items-center">
                                    <span id="eventCount" class="text-sm bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded">
                                        0 个事件
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="p-4">
                            <div id="eventsList" class="max-h-96 overflow-hidden relative flex items-center justify-center bg-gradient-to-b from-transparent via-gray-50 to-gray-100 dark:from-transparent dark:via-gray-800 dark:to-gray-900 rounded-lg" style="min-height: 200px;">
                            <!-- Carousel indicator dots -->
                            <div id="carouselIndicators" class="absolute bottom-2 left-1/2 transform -translate-x-1/2 flex space-x-2 z-10"></div>
                            <!-- Events will be displayed here with carousel animation -->
                                <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                                    等待事件...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 系统状态 -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
                        <div class="px-6 py-4 border-b dark:border-gray-700">
                            <h2 class="text-lg font-semibold text-gray-900 dark:text-white">系统状态</h2>
                        </div>
                        <div class="p-6">
                            <div class="space-y-4">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-gray-600 dark:text-gray-400">数据库连接</span>
                                    <span id="dbStatus" class="px-2 py-1 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 text-xs rounded-full">
                                        断开
                                    </span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-gray-600 dark:text-gray-400">CDC 复制状态</span>
                                    <div class="flex items-center space-x-2">
                                        <span id="cdcStatus" class="px-2 py-1 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 text-xs rounded-full">
                                            未运行
                                        </span>
                                        <button id="quickFixSlot" onclick="autoFixReplicationSlot()" class="hidden px-2 py-1 bg-yellow-500 hover:bg-yellow-600 text-white text-xs rounded transition-colors">
                                            快速修复
                                        </button>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-gray-600 dark:text-gray-400">WebSocket 连接</span>
                                    <span id="wsStatus" class="px-2 py-1 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 text-xs rounded-full">
                                        断开
                                    </span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-gray-600 dark:text-gray-400">最后活动时间</span>
                                    <span id="lastActivity" class="text-sm text-gray-900 dark:text-white">-</span>
                                </div>
                                <div class="pt-4 border-t dark:border-gray-700 space-y-2">
                                    <button onclick="resetReplicationSlot()" class="w-full bg-yellow-600 text-white py-2 px-4 rounded-md hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 transition-colors text-sm">
                                        重置复制槽
                                    </button>
                                    <button onclick="diagnoseReplicationSlot()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors text-sm">
                                        诊断复制槽
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 加载动画 -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-40">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 flex items-center space-x-4">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <span class="text-gray-700 dark:text-gray-300">处理中...</span>
        </div>
    </div>

    <script>
        // 配置和状态管理
        const API_BASE_URL = window.location.origin + '/api';
        const state = {
            token: localStorage.getItem('authToken'),
            currentPage: 1,
            pageSize: 3, // 修改为每页显示3条记录
            totalPages: 1,
            totalCount: 0,
            searchTerm: '',
            statusFilter: 'All',
            eventCount: 0,
            isConnected: false,
            ws: null,
            charts: {},
            retryCount: 0,
            maxRetries: 3
        };

        // 错误边界处理
        function showError(message) {
            const errorBoundary = document.getElementById('errorBoundary');
            const errorMessage = document.getElementById('errorMessage');

            errorMessage.textContent = message;
            errorBoundary.classList.remove('hidden');
            errorBoundary.classList.add('fade-in');

            console.error('Application Error:', message);
        }

        function hideError() {
            document.getElementById('errorBoundary').classList.add('hidden');
        }

        // 安全的数据获取函数
        async function safeFetch(url, options = {}) {
            try {
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };

                if (state.token) {
                    headers['Authorization'] = `Bearer ${state.token}`;
                }

                const response = await fetch(url, {
                    ...options,
                    headers
                });

                if (response.status === 401) {
                    // 未授权，跳转到登录
                    logout();
                    throw new Error('认证失效，请重新登录');
                }

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                return await response.json();
            } catch (error) {
                showError(`请求失败: ${error.message}`);
                throw error;
            }
        }

        // 认证相关函数
        function checkAuth() {
            if (!state.token) {
                document.getElementById('loginModal').classList.remove('hidden');
                document.getElementById('app').classList.add('hidden');
                return false;
            }

            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            return true;
        }

        async function login(event) {
            event.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            showLoading();

            try {
                const response = await fetch(`${window.location.origin}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });

                if (!response.ok) {
                    throw new Error('登录失败，请检查用户名和密码');
                }

                const data = await response.json();
                state.token = data.token;
                localStorage.setItem('authToken', data.token);

                checkAuth();
                initializeApp();
                showNotification('登录成功！', 'success');

            } catch (error) {
                showError(`登录失败: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        function logout() {
            state.token = null;
            localStorage.removeItem('authToken');
            if (state.ws) {
                state.ws.close();
            }
            checkAuth();
        }

        // WebSocket 连接
        function connectWebSocket() {
            try {
                // Connect to new real-time CDC notifications endpoint
                const wsUrl = `${window.location.origin.replace('http', 'ws')}/api/realtime`;
                state.ws = new WebSocket(wsUrl);

                state.ws.onopen = () => {
                    updateConnectionStatus(true);
                    document.getElementById('wsStatus').className = 'px-2 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 text-xs rounded-full';
                    document.getElementById('wsStatus').textContent = '已连接';
                    state.retryCount = 0;
                    showNotification('WebSocket 连接已建立', 'success');
                };

                state.ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                };

                state.ws.onclose = () => {
                    updateConnectionStatus(false);
                    document.getElementById('wsStatus').className = 'px-2 py-1 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 text-xs rounded-full';
                    document.getElementById('wsStatus').textContent = '断开';

                    // 自动重连
                    if (state.retryCount < state.maxRetries) {
                        state.retryCount++;
                        setTimeout(() => {
                            showNotification(`尝试重新连接... (${state.retryCount}/${state.maxRetries})`, 'info');
                            connectWebSocket();
                        }, 3000);
                    }
                };

                state.ws.onerror = (error) => {
                    showError(`WebSocket 错误: ${error.message}`);
                };

            } catch (error) {
                showError(`创建 WebSocket 连接失败: ${error.message}`);
            }
        }

        function handleWebSocketMessage(data) {
            switch (data.Type) {
                case 'Connected':
                    showNotification('实时通知已连接', 'success');
                    break;

                case 'OrderStatusChanged':
                    handleOrderStatusChange(data.Data);
                    break;

                case 'OrderCreated':
                    handleOrderCreated(data.Data);
                    break;

                case 'OrderUpdated':
                    handleOrderUpdated(data.Data);
                    break;

                case 'CdcEvent':
                    handleGenericCdcEvent(data.Data);
                    break;
            }
        }

        // Handle real-time order status change
        function handleOrderStatusChange(data) {

            // Refresh orders list to show updated status
            loadOrders();

            // Update charts to reflect new status distribution
            updateCharts();

            // Show notification to user
            showNotification(
                `订单 ${data.OrderId} 状态已更新: ${data.OldStatus} → ${data.NewStatus}`,
                'info'
            );

            // Add to CDC event stream
            const eventData = {
                id: generateEventId(),
                eventType: 'OrderStatusChanged',
                aggregateType: 'Order',
                aggregateId: data.OrderId,
                createdAt: new Date().toISOString(),
                processed: true,
                payload: JSON.stringify({
                    OldStatus: data.OldStatus,
                    NewStatus: data.NewStatus,
                    OrderId: data.OrderId
                })
            };

            addEventToCarousel(eventData);
        }

        // Handle real-time order creation
        function handleOrderCreated(data) {

            // Refresh orders list
            loadOrders();

            // Update charts
            updateCharts();

            // Show notification
            showNotification(
                `新订单创建: ${data.CustomerName} - ¥${data.Amount}`,
                'success'
            );

            // Add to CDC event stream
            const eventData = {
                id: generateEventId(),
                eventType: 'OrderCreated',
                aggregateType: 'Order',
                aggregateId: data.OrderId,
                createdAt: data.CreatedAt,
                processed: true,
                payload: JSON.stringify(data)
            };

            addEventToCarousel(eventData);
        }

        // Handle real-time order update
        function handleOrderUpdated(data) {

            // Refresh orders list
            loadOrders();

            // Update charts
            updateCharts();

            // Show notification
            showNotification(
                `订单 ${data.OrderId} 已更新: ${data.ChangedFields.join(', ')}`,
                'info'
            );
        }

        // Handle generic CDC event
        function handleGenericCdcEvent(data) {

            // Refresh CDC events
            loadEventsFromAPI();

            // Show notification for important tables
            if (data.TableName === 'orders' || data.TableName === 'OutboxEvents') {
                showNotification(
                    `数据库变更: ${data.EventType} on ${data.TableName}`,
                    'info'
                );
            }
        }

        // Generate unique event ID
        function generateEventId() {
            return 'evt_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // 主题切换
        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('themeIcon').textContent = isDark ? '☀️' : '🌙';

            // 重新渲染图表以适应主题
            if (state.charts.orders) {
                state.charts.orders.destroy();
                state.charts.status.destroy();
                loadCharts();
            }
        }

        // 加载动画
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // 连接状态
        function updateConnectionStatus(connected) {
            state.isConnected = connected;
            const statusElement = document.getElementById('connectionStatus');
            const indicator = statusElement.querySelector('span');
            const text = statusElement.querySelector('span:last-child');

            if (connected) {
                indicator.className = 'w-3 h-3 bg-green-500 rounded-full mr-2 pulse-green';
                text.textContent = '已连接';
                text.className = 'text-sm text-green-600 dark:text-green-400';
            } else {
                indicator.className = 'w-3 h-3 bg-red-500 rounded-full mr-2';
                text.textContent = '断开连接';
                text.className = 'text-sm text-red-600 dark:text-red-400';
            }
        }

        // 图表初始化 - 使用与updateCharts一致的简化配置
        function loadCharts() {
            
            // 订单趋势图表
            const ordersCtx = document.getElementById('ordersChart').getContext('2d');
            state.charts.orders = new Chart(ordersCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: '订单数量',
                            data: [],
                            borderColor: '#3B82F6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1
                        },
                        {
                            label: '订单金额',
                            data: [],
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        },
                        x: {
                            display: true
                        }
                    }
                }
            });

            // 状态分布图表
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            state.charts.status = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#3B82F6',
                            '#F59E0B',
                            '#10B981',
                            '#EF4444'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom'
                        }
                    }
                }
            });

                    }

        // 更新图表数据
        async function updateCharts() {
            try {
                                const stats = await safeFetch(`${window.location.origin}/orders/stats`);

                
                // 检查趋势数据的实际字段名
                if (stats.trendData && stats.trendData.length > 0) {
                                    }

                // 检查状态数据的实际字段名
                if (stats.statusStats && stats.statusStats.length > 0) {
                                    }

                // 检查图表是否存在
                if (!state.charts.orders || !state.charts.status) {
                    console.error('图表未初始化，重新创建...');
                    loadCharts();
                    // 等待图表创建完成后再继续
                    await new Promise(resolve => setTimeout(resolve, 200));
                }

                // 更新趋势图表
                if (stats.trendData && stats.trendData.length > 0) {
                    
                    // 如果图表不存在，先创建
                    if (!state.charts.orders) {

                        const ordersCtx = document.getElementById('ordersChart').getContext('2d');
                        state.charts.orders = new Chart(ordersCtx, {
                            type: 'line',
                            data: {
                                labels: [],
                                datasets: [
                                    {
                                        label: '订单数量',
                                        data: [],
                                        borderColor: '#3B82F6',
                                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                        borderWidth: 2,
                                        fill: true,
                                        tension: 0.1
                                    },
                                    {
                                        label: '订单金额',
                                        data: [],
                                        borderColor: '#10B981',
                                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                        borderWidth: 2,
                                        fill: false,
                                        tension: 0.1
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: 'top'
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    },
                                    x: {
                                        display: true
                                    }
                                }
                            }
                        });
                    }

                    // 更新数据而不是重新创建图表
                    const ordersLabels = stats.trendData.map(t => t.date);
                    const ordersCountData = stats.trendData.map(t => t.count);
                    const ordersAmountData = stats.trendData.map(t => t.amount);

                    state.charts.orders.data.labels = ordersLabels;
                    state.charts.orders.data.datasets[0].data = ordersCountData;
                    state.charts.orders.data.datasets[1].data = ordersAmountData;

                    // 使用 'none' 模式更新，避免动画导致的性能问题
                    state.charts.orders.update('none');


                } else {

                }

                // 更新状态图表
                if (stats.statusStats && stats.statusStats.length > 0) {


                    // 如果图表不存在，先创建
                    if (!state.charts.status) {

                        const statusCtx = document.getElementById('statusChart').getContext('2d');
                        state.charts.status = new Chart(statusCtx, {
                            type: 'doughnut',
                            data: {
                                labels: [],
                                datasets: [{
                                    data: [],
                                    backgroundColor: [
                                        '#3B82F6',
                                        '#F59E0B',
                                        '#10B981',
                                        '#EF4444'
                                    ],
                                    borderWidth: 2,
                                    borderColor: '#fff'
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: 'bottom'
                                    }
                                }
                            }
                        });
                    }

                    // 更新数据而不是重新创建图表
                    const statusLabels = stats.statusStats.map(s => s.status);
                    const statusCountData = stats.statusStats.map(s => s.count);

                    state.charts.status.data.labels = statusLabels;
                    state.charts.status.data.datasets[0].data = statusCountData;

                    // 使用 'none' 模式更新，避免动画导致的性能问题
                    state.charts.status.update('none');


                } else {

                }

                // 更新统计卡片
                if (stats.totalOrders !== undefined) {
                    document.getElementById('totalOrders').textContent = stats.totalOrders.toLocaleString();
                }
                if (stats.todayOrders !== undefined) {
                    document.getElementById('todayEvents').textContent = stats.todayOrders.toLocaleString();
                }



                
            } catch (error) {
                console.error('更新图表失败:', error);
                // 如果更新失败，尝试重新创建图表
                try {

                    loadCharts();
                } catch (recreateError) {
                    console.error('重新创建图表也失败:', recreateError);
                }
            }
        }

        // 订单管理
        async function loadOrders(page = state.currentPage) {
            try {
                const params = new URLSearchParams({
                    page: page,
                    pageSize: state.pageSize,
                    search: state.searchTerm,
                    status: state.statusFilter
                });

                const data = await safeFetch(`${API_BASE_URL}/orders?${params}`);

                state.currentPage = data.page;
                state.totalPages = data.totalPages;
                state.totalCount = data.totalCount;

                displayOrders(data.orders);
                updatePagination();

            } catch (error) {
                console.error('❌ [DEBUG] 加载订单失败:', error);
            }
        }

        function displayOrders(orders) {
            const ordersList = document.getElementById('ordersList');

            if (orders.length === 0) {
                ordersList.innerHTML = `
                    <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                        暂无订单数据
                    </div>
                `;
                return;
            }

            ordersList.innerHTML = orders.map(order => `
                <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:shadow-md transition-shadow fade-in">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h3 class="font-semibold text-gray-900 dark:text-white">${order.customerName}</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">订单ID: ${order.id}</p>
                        </div>
                        <span class="px-2 py-1 text-xs rounded-full ${
                            order.status === 'Completed' ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200' :
                            order.status === 'Processing' ? 'bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200' :
                            order.status === 'Cancelled' ? 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200' :
                            'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200'
                        }">
                            ${order.status}
                        </span>
                    </div>
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-gray-900 dark:text-white font-medium">¥${order.amount.toFixed(2)}</span>
                        <span class="text-gray-500 dark:text-gray-400">${new Date(order.createdAt).toLocaleString()}</span>
                    </div>
                    <div class="mt-3 flex space-x-2">
                        <select id="status-${order.id}" class="text-sm border border-gray-300 dark:border-gray-600 rounded px-2 py-1 flex-1 dark:bg-gray-700 dark:text-white">
                            <option value="Pending">待处理</option>
                            <option value="Processing">处理中</option>
                            <option value="Completed">已完成</option>
                            <option value="Cancelled">已取消</option>
                        </select>
                        <button onclick="updateOrderStatus('${order.id}')"
                                class="text-sm bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition-colors">
                            更新
                        </button>
                    </div>
                </div>
            `).join('');

            // 设置当前状态
            orders.forEach(order => {
                const select = document.getElementById(`status-${order.id}`);
                if (select) select.value = order.status;
            });
        }

        function updatePagination() {
            const start = ((state.currentPage - 1) * state.pageSize) + 1;
            const end = Math.min(state.currentPage * state.pageSize, state.totalCount);

            document.getElementById('pageInfo').textContent = `${start}-${end}`;
            document.getElementById('totalCount').textContent = state.totalCount;

            document.getElementById('prevPage').disabled = state.currentPage === 1;
            document.getElementById('nextPage').disabled = state.currentPage === state.totalPages;

            // 生成页码显示
            let pageNumbers = '';
            for (let i = 1; i <= state.totalPages; i++) {
                if (i === state.currentPage) {
                    pageNumbers += `<span class="px-3 py-1 bg-blue-600 text-white rounded-md font-medium">${i}</span>`;
                } else {
                    pageNumbers += `<button onclick="changeToPage(${i})" class="px-3 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">${i}</button>`;
                }
            }
            document.getElementById('pageNumbers').innerHTML = pageNumbers;
        }

        function changePage(delta) {
            const newPage = state.currentPage + delta;
            if (newPage >= 1 && newPage <= state.totalPages) {
                loadOrders(newPage);
            }
        }

        function changeToPage(page) {
            if (page >= 1 && page <= state.totalPages) {
                loadOrders(page);
            }
        }

        // 创建订单
        async function createOrder(event) {
            event.preventDefault();

            const formData = {
                customerName: document.getElementById('customerName').value,
                amount: parseFloat(document.getElementById('orderAmount').value)
            };

            if (!formData.customerName || !formData.amount) {
                showError('请填写完整的订单信息');
                return;
            }

            showLoading();

            try {
                await safeFetch(`${API_BASE_URL}/orders`, {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                // 清空表单
                document.getElementById('createOrderForm').reset();

                // 重新加载数据
                await loadOrders();
                await updateCharts();

                showNotification('订单创建成功！', 'success');

            } catch (error) {
                console.error('创建订单失败:', error);
            } finally {
                hideLoading();
            }
        }

        // 更新订单状态
        async function updateOrderStatus(orderId) {
            const statusElement = document.getElementById(`status-${orderId}`);
            if (!statusElement) {
                showError('状态元素未找到');
                return;
            }

            const newStatus = statusElement.value;

            try {
                const responseData = await safeFetch(`${API_BASE_URL}/orders/${orderId}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ status: newStatus })
                });

                await loadOrders();
                await updateCharts();

                showNotification('订单状态更新成功！', 'success');

            } catch (error) {
                console.error('Error in updateOrderStatus:', error);
                showError('更新状态失败: ' + error.message);
            }
        }

        // 重置复制槽
        async function resetReplicationSlot() {
            showLoading();
            try {
                showNotification('正在检查复制槽状态...', 'info');

                // 首先获取复制槽状态
                const statusResponse = await fetch(`${window.location.origin}/api/replication/slot-status`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${state.token}`
                    }
                });

                if (statusResponse.ok) {
                    const slotStatus = await statusResponse.json();


                    if (slotStatus.IsActive) {
                        showNotification('复制槽当前活跃，需要强制清理', 'warning');
                        if (confirm('复制槽正在被使用。是否要强制清理？\n\n这会终止所有活跃连接。')) {
                            await forceCleanupReplicationSlot();
                        }
                        return;
                    }
                }

                showNotification('正在重置复制槽...', 'info');
                const response = await fetch(`${window.location.origin}/api/replication/reset-slot`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${state.token}`
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('重置错误详情:', errorData);
                    throw new Error(errorData.detail || errorData.message || errorData.Error || '重置失败');
                }

                const result = await response.json();
                showNotification(result.message || '复制槽重置成功', 'success');

                // 等待一下后重新检查健康状态
                setTimeout(() => {
                    checkHealth();
                }, 2000);

            } catch (error) {
                console.error('重置复制槽失败:', error);

                // 如果普通重置失败，询问是否强制清理
                if (confirm(`普通重置失败: ${error.message}\n\n是否要强制清理复制槽？这会终止所有活跃连接。`)) {
                    await forceCleanupReplicationSlot();
                } else {
                    showError(`重置复制槽失败: ${error.message}`);
                }
            } finally {
                hideLoading();
            }
        }

        // 强制清理复制槽
        async function forceCleanupReplicationSlot() {
            try {
                showNotification('正在强制清理复制槽...', 'info');
                const response = await fetch(`${window.location.origin}/api/replication/force-cleanup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${state.token}`
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || errorData.message || '强制清理失败');
                }

                const result = await response.json();
                showNotification(result.message || '复制槽强制清理成功', 'success');

                // 等待一下后重新检查健康状态
                setTimeout(() => {
                    checkHealth();
                }, 3000);

            } catch (error) {
                console.error('强制清理复制槽失败:', error);
                showError(`强制清理失败: ${error.message}`);
            }
        }

        // 诊断复制槽
        async function diagnoseReplicationSlot() {
            showLoading();
            try {
                showNotification('正在诊断复制槽状态...', 'info');

                // 获取复制槽状态
                const slotResponse = await fetch(`${window.location.origin}/api/replication/slot-status`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${state.token}`
                    }
                });

                // 获取详细诊断信息
                const diagResponse = await fetch(`${window.location.origin}/api/replication/diagnose`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${state.token}`
                    }
                });

                const slotData = slotResponse.ok ? await slotResponse.json() : { error: 'Failed to get slot status' };
                const diagData = diagResponse.ok ? await diagResponse.json() : { error: 'Failed to get diagnostics' };





                // 创建诊断报告
                const report = `
=== 复制槽诊断报告 ===

复制槽状态:
${JSON.stringify(slotData, null, 2)}

详细诊断信息:
${JSON.stringify(diagData, null, 2)}

时间: ${new Date().toLocaleString()}
                `.trim();

                // 显示诊断结果
                alert(report);

                // 提供修复建议
                if (slotData.IsActive) {
                    showNotification('复制槽活跃，建议使用强制清理', 'warning');
                } else if (slotData.Error) {
                    showNotification('复制槽存在错误，建议强制重置', 'error');
                } else {
                    showNotification('复制槽状态正常，请检查其他配置', 'success');
                }

            } catch (error) {
                console.error('诊断失败:', error);
                showError(`诊断失败: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // Carousel-style event stream variables
        let eventCarousel = [];
        let currentEventIndex = 0;
        let carouselInterval = null;
        let lastDisplayedEventIds = new Set();

        // Initialize carousel with events
        async function initializeEventCarousel() {
            try {
                const response = await fetch('/api/events');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                // Update event count
                state.eventCount = data.totalCount;
                document.getElementById('eventCount').textContent = `${data.totalCount} 个事件`;

                // Get newest events for carousel
                eventCarousel = data.events.slice(0, 5).reverse(); // Take 5 newest events for rotation

                if (eventCarousel.length > 0) {
                    // Start carousel if not running
                    if (!carouselInterval) {
                        startEventCarousel();
                    }

                }

            } catch (error) {
                console.error('❌ Error initializing carousel:', error);
            }
        }

        // Start carousel animation
        function startEventCarousel() {
            // Clear existing interval
            if (carouselInterval) {
                clearInterval(carouselInterval);
            }

            // Update carousel indicators
            updateCarouselIndicators();

            // Display first event immediately
            displayCarouselEvent();

            // Start rotation - change event every 3 seconds
            carouselInterval = setInterval(() => {
                currentEventIndex = (currentEventIndex + 1) % eventCarousel.length;
                displayCarouselEvent();
            }, 3000);
        }

        // Update carousel indicator dots
        function updateCarouselIndicators() {
            const indicatorsContainer = document.getElementById('carouselIndicators');
            indicatorsContainer.innerHTML = '';

            eventCarousel.forEach((_, index) => {
                const dot = document.createElement('button');
                dot.className = `w-2 h-2 rounded-full transition-all duration-300 ${
                    index === currentEventIndex
                    ? 'bg-blue-600 dark:bg-blue-400 w-8'
                    : 'bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500'
                }`;
                dot.onclick = () => {
                    currentEventIndex = index;
                    displayCarouselEvent();
                    updateCarouselIndicators();
                };
                indicatorsContainer.appendChild(dot);
            });
        }

        // Display current carousel event with bottom-to-top animation
        function displayCarouselEvent() {
            if (eventCarousel.length === 0) return;

            const eventsList = document.getElementById('eventsList');
            const eventData = eventCarousel[currentEventIndex];

            // Create event element with animation
            const eventElement = createEventElement(eventData);

            // Add fade-in animation from bottom
            eventElement.style.opacity = '0';
            eventElement.style.transform = 'translateY(30px)';
            eventElement.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';

            // Clear existing content and add new event with indicators
            eventsList.innerHTML = '';

            // Re-add indicators container
            const indicatorsContainer = document.createElement('div');
            indicatorsContainer.id = 'carouselIndicators';
            indicatorsContainer.className = 'absolute bottom-2 left-1/2 transform -translate-x-1/2 flex space-x-2 z-10';
            eventsList.appendChild(indicatorsContainer);

            eventsList.appendChild(eventElement);

            // Update indicators
            updateCarouselIndicators();

            // Trigger slide-up animation
            setTimeout(() => {
                eventElement.style.opacity = '1';
                eventElement.style.transform = 'translateY(0)';
            }, 50);

        }

        // Load events from REST API (now initializes carousel)
        async function loadEventsFromAPI() {
            await initializeEventCarousel();
        }

        // Create event element for carousel
        function createEventElement(eventData) {
            const eventElement = document.createElement('div');
            eventElement.className = `border border-gray-200 dark:border-gray-700 rounded-lg p-4 flex-shrink-0 bg-white dark:bg-gray-800 shadow-md`;

            // Handle both old and new data structures - API returns lowercase
            const eventType = eventData.EventType || eventData.eventType;
            const aggregateType = eventData.AggregateType || eventData.aggregateType;
            const aggregateId = eventData.AggregateId || eventData.aggregateId;
            const timestamp = eventData.createdAt || eventData.CreatedAt || eventData.timestamp;
            const payload = eventData.payload || eventData.Payload;

            // Fix date handling - create proper date from ISO string or fallback
            const formatDate = (dateString) => {
                if (!dateString) return 'N/A';
                try {
                    const date = new Date(dateString);
                    return isNaN(date.getTime()) ? 'Invalid Date' : date.toLocaleTimeString();
                } catch (e) {
                    return 'Invalid Date';
                }
            };

            eventElement.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h3 class="font-semibold text-gray-900 dark:text-white">${eventType}</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">${aggregateType} - ${aggregateId}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">
                            Processed: ${eventData.processed !== undefined ? (eventData.processed ? '✅' : '⏳') : (eventData.Processed !== undefined ? (eventData.Processed ? '✅' : '⏳') : '⏳')}
                            ${eventData.processedAt ? `(${formatDate(eventData.processedAt)})` : (eventData.ProcessedAt ? `(${formatDate(eventData.ProcessedAt)})` : '')}
                        </p>
                    </div>
                    <span class="text-xs text-gray-500 dark:text-gray-400">${formatDate(timestamp)}</span>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 rounded p-2 text-sm font-mono text-gray-700 dark:text-gray-300 overflow-x-auto max-h-32">
                    <pre>${payload ? JSON.stringify(JSON.parse(payload), null, 2) : 'null'}</pre>
                </div>
            `;

            return eventElement;
        }

        // CDC 事件处理
        function addEvent(eventData) {
            const eventsList = document.getElementById('eventsList');

            const eventElement = document.createElement('div');
            eventElement.className = `border border-gray-200 dark:border-gray-700 rounded-lg p-4 fade-in new-event flex-shrink-0`;

            // Handle both old and new data structures - API returns lowercase
            const eventType = eventData.EventType || eventData.eventType;
            const aggregateType = eventData.AggregateType || eventData.aggregateType;
            const aggregateId = eventData.AggregateId || eventData.aggregateId;
            const timestamp = eventData.createdAt || eventData.CreatedAt || eventData.timestamp;
            const payload = eventData.payload || eventData.Payload;

            // Fix date handling - create proper date from ISO string or fallback
            const formatDate = (dateString) => {
                if (!dateString) return 'N/A';
                try {
                    const date = new Date(dateString);
                    return isNaN(date.getTime()) ? 'Invalid Date' : date.toLocaleTimeString();
                } catch (e) {
                    return 'Invalid Date';
                }
            };

            eventElement.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h3 class="font-semibold text-gray-900 dark:text-white">${eventType}</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">${aggregateType} - ${aggregateId}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">
                            Processed: ${eventData.processed !== undefined ? (eventData.processed ? '✅' : '⏳') : (eventData.Processed !== undefined ? (eventData.Processed ? '✅' : '⏳') : '⏳')}
                            ${eventData.processedAt ? `(${formatDate(eventData.processedAt)})` : (eventData.ProcessedAt ? `(${formatDate(eventData.ProcessedAt)})` : '')}
                        </p>
                    </div>
                    <span class="text-xs text-gray-500 dark:text-gray-400">${formatDate(timestamp)}</span>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 rounded p-2 text-sm font-mono text-gray-700 dark:text-gray-300 overflow-x-auto">
                    <pre>${payload ? JSON.stringify(JSON.parse(payload), null, 2) : 'null'}</pre>
                </div>
            `;

            // Add event to the end (bottom) - with flex-col-reverse this will appear at top
            eventsList.appendChild(eventElement);

            // Auto-scroll to show newest event (which will be at the top due to flex-col-reverse)
            setTimeout(() => {
                eventsList.scrollTop = 0;
            }, 100);

            // 限制显示的事件数量为2条 (移除最旧的事件 - 底部的)
            if (eventsList.children.length > 2) {
                eventsList.removeChild(eventsList.lastChild);
            }
        }

        // 健康检查
        async function checkHealth() {
            try {
                const startTime = performance.now();
                const health = await safeFetch(`${window.location.origin}/health`);
                const endTime = performance.now();

                updateConnectionStatus(true);
                document.getElementById('dbStatus').className = 'px-2 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 text-xs rounded-full';
                document.getElementById('dbStatus').textContent = '正常';
                document.getElementById('cdcStatus').className = 'px-2 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 text-xs rounded-full';
                document.getElementById('cdcStatus').textContent = '运行中';
                document.getElementById('responseTime').textContent = `${Math.round(endTime - startTime)}ms`;
                document.getElementById('lastActivity').textContent = new Date().toLocaleTimeString();
                document.getElementById('quickFixSlot').classList.add('hidden');

            } catch (error) {
                updateConnectionStatus(false);
                document.getElementById('dbStatus').className = 'px-2 py-1 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 text-xs rounded-full';
                document.getElementById('dbStatus').textContent = '异常';

                // Check if it's a replication slot issue
                if (error.message && error.message.includes('复制槽不活跃')) {
                    document.getElementById('cdcStatus').className = 'px-2 py-1 bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 text-xs rounded-full';
                    document.getElementById('cdcStatus').textContent = '复制槽问题';
                    document.getElementById('quickFixSlot').classList.remove('hidden');

                    // Show notification about the issue and offer quick fix
                    showNotification('检测到复制槽不活跃问题。点击"快速修复"按钮自动修复。', 'warning');
                } else {
                    document.getElementById('cdcStatus').className = 'px-2 py-1 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 text-xs rounded-full';
                    document.getElementById('cdcStatus').textContent = '未运行';
                    document.getElementById('quickFixSlot').classList.add('hidden');
                }
            }
        }

        // 自动修复复制槽问题
        async function autoFixReplicationSlot() {
            showLoading();
            try {
                showNotification('正在尝试修复复制槽问题...', 'info');

                // First try normal reset
                await resetReplicationSlot();

            } catch (error) {
                console.error('自动修复复制槽失败:', error);
                showError(`自动修复失败: ${error.message}\n请手动点击"重置复制槽"按钮`);
            } finally {
                hideLoading();
            }
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg fade-in z-50 ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // 初始化应用
        async function initializeApp() {
            try {
                // 设置事件监听器（登录表单已在全局设���）
                document.getElementById('createOrderForm').addEventListener('submit', createOrder);
                document.getElementById('clearEvents').addEventListener('click', () => {
                    document.getElementById('eventsList').innerHTML = '<div class="text-center py-8 text-gray-500 dark:text-gray-400">点击刷新按钮重新加载事件</div>';
                    state.eventCount = 0;
                    document.getElementById('eventCount').textContent = '0 个事件';
                });

                // 搜索和过滤
                document.getElementById('searchOrders').addEventListener('input', (e) => {
                    state.searchTerm = e.target.value;
                });

                document.getElementById('statusFilter').addEventListener('change', (e) => {
                    state.statusFilter = e.target.value;
                });

                // 加载主题偏好
                const savedTheme = localStorage.getItem('theme') || 'light';
                if (savedTheme === 'dark') {
                    document.documentElement.classList.add('dark');
                    document.getElementById('themeIcon').textContent = '☀️';
                }

                // 等待 DOM 完全准备就绪后再初始化图表
                setTimeout(async () => {
                    // 初始化图表
                    loadCharts();

                    // 初始加载数据
                    await checkHealth();
                    await loadOrders();
                    await updateCharts();
                    await loadEventsFromAPI(); // Load events from REST API
                }, 100);

                // 连接 WebSocket (for other real-time features)
                connectWebSocket();

                // 定期检查健康状态和更新事件
                setInterval(checkHealth, 10000);
                setInterval(loadEventsFromAPI, 10000); // Poll for new events every 10 seconds (reduced from 2s)

                // 定期刷新图表
                setInterval(updateCharts, 30000);

            } catch (error) {
                showError(`应用初始化失败: ${error.message}`);
            }
        }

        // 全局错误处理
        window.addEventListener('error', (event) => {
            showError(`未处理的错误: ${event.error?.message || event.message}`);
        });

        window.addEventListener('unhandledrejection', (event) => {
            showError(`未处理的 Promise 拒绝: ${event.reason?.message || event.reason}`);
        });

        // 设置登录表单事件监听器（必须在显示登录界面之前设置）
        document.getElementById('loginForm').addEventListener('submit', login);

        // 开发者模式 - 按Ctrl+Shift+R强制重置复制槽
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey && event.shiftKey && event.key === 'R') {
                event.preventDefault();

                if (confirm('开发者模式：确定要强制重置复制槽吗？')) {
                    forceCleanupReplicationSlot();
                }
            }
        });

        // 启动应用
        if (checkAuth()) {
            initializeApp();
        }
    </script>
</body>
</html>